services:
  user-service:
    build:
      context: ./user
      dockerfile: Dockerfile
    image: bomb0069/observability-user-service:lab17-1.0.0
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://user-db:5432/user
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      POINT_SERVICE_URL: http://point-service:8001
      OTEL_SERVICE_NAME: user-service
      # Send traces to OpenTelemetry Collector (not directly to LGTM)
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: http://otel-collector:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      OTEL_RESOURCE_ATTRIBUTES: service.name=user-service
      OTEL_TRACES_EXPORTER: otlp
      # No sampling here - let collector do tail-based sampling
      OTEL_TRACES_SAMPLER: always_on
    ports:
      - 8080:8080
    depends_on:
      otel-collector:
        condition: service_started
      user-db:
        condition: service_healthy
      point-service:
        condition: service_started
    restart: always

  user-db:
    image: "postgres:16.3"
    environment:
      POSTGRES_DB: user
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - ./user/tearup/init.sql:/docker-entrypoint-initdb.d/user.sql
    ports:
      - "5432:5432"
    restart: always
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -d $$POSTGRES_DB -h localhost -p 5432 -U $$POSTGRES_USER",
        ]
      interval: 10s
      timeout: 10s
      retries: 60

  point-service:
    build:
      context: ./point
      dockerfile: Dockerfile
    image: bomb0069/observability-point-service:lab17-1.0.0
    environment:
      DB_HOST: point-db
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: root_password
      DB_NAME: point_db
      OTEL_SERVICE_NAME: point-service
      # Send traces to OpenTelemetry Collector (not directly to LGTM)
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: http://otel-collector:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      OTEL_RESOURCE_ATTRIBUTES: service.name=point-service
      OTEL_TRACES_EXPORTER: otlp
      # No sampling here - let collector do tail-based sampling
      OTEL_TRACES_SAMPLER: always_on
    ports:
      - 8001:8001
    depends_on:
      otel-collector:
        condition: service_started
      point-db:
        condition: service_healthy
    restart: always

  point-db:
    image: "mysql:8.3.0"
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: point_db
      MYSQL_USER: point_user
      MYSQL_PASSWORD: point_password
    volumes:
      - ./point/tearup/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    restart: always
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-proot_password",
        ]
      interval: 10s
      timeout: 10s
      retries: 60

  # OpenTelemetry Collector for tail-based sampling
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.91.0
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4317:4317" # OTLP gRPC receiver
      - "4318:4318" # OTLP HTTP receiver
      - "8888:8888" # Prometheus metrics
      - "13133:13133" # Health check
    depends_on:
      lgtm:
        condition: service_started
    restart: always

  lgtm:
    image: grafana/otel-lgtm:latest
    ports:
      - "3000:3000" # Grafana UI
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    restart: always
