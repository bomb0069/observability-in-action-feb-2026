input {
  beats {
    port => 5044
  }
}

filter {
  # Parse Apache combined log format for flog
  if [log_type] == "apache" and [app] == "flog" {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
      overwrite => [ "message" ]
    }
    
    # Parse timestamp
    date {
      match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
      target => "@timestamp"
    }
    
    # Map fields to simple names
    mutate {
      rename => {
        "clientip" => "remote_ip"
        "auth" => "[user][name]"
        "verb" => "[http][request][method]"
        "request" => "[url][original]"
        "httpversion" => "[http][version]"
        "response" => "[http][response][status_code]"
        "bytes" => "[http][response][body][bytes]"
        "referrer" => "[http][request][referrer]"
        "agent" => "[user_agent][original]"
      }
      convert => {
        "[http][response][status_code]" => "integer"
        "[http][response][body][bytes]" => "integer"
      }
      remove_field => ["timestamp"]
    }
  }
  
  # Normalize JSON logs from flog2 to ECS format
  if [log_type] == "json" and [app] == "flog2" {
    # Map flog2 JSON fields to ECS format
    mutate {
      # Rename fields to ECS format (don't rename 'host' to avoid conflict)
      rename => {
        "user_name" => "[user][name]"
        "method" => "[http][request][method]"
        "request" => "[url][original]"
        "protocol" => "[http][version]"
        "status" => "[http][response][status_code]"
        "bytes" => "[http][response][body][bytes]"
        "referer" => "[http][request][referrer]"
        "user_agent" => "[user_agent][original]"
      }
      # Copy host field to remote_ip before filebeat overwrites it
      copy => { "host" => "remote_ip" }
      # Convert types
      convert => {
        "[http][response][status_code]" => "integer"
        "[http][response][body][bytes]" => "integer"
      }
      # Remove original host field to avoid confusion
      remove_field => ["host"]
    }
  }
}

output {
  # Route all logs to unified index with app field for filtering
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "unified-logs-%{+YYYY.MM.dd}"
    manage_template => true
  }
}
